!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(1));global.Promise=o.default;const s=i(n(2)),a=i(n(3)),u=n(4),d=n(5),c=i(n(6)),l=i(n(10)),f=new c.default,m=new l.default,h=s.default().use(s.default.static(u.join(__dirname,"/static"))).use(s.default.json()).use(s.default.urlencoded({extended:!0})).get("/",(e,t)=>{t.sendFile(u.join(__dirname,"/static/index.html"))}).get("/sign-in",(e,t)=>{t.sendFile(u.join(__dirname,"/static/index.html"))}).get("/sign-up",(e,t)=>{t.sendFile(u.join(__dirname,"/static/index.html"))}).get("/chat",(e,t)=>{t.sendFile(u.join(__dirname,"/static/index.html"))}).get("/getLogs",(e,t)=>{m.info(`logs were sent to ${e.url}`),t.sendFile(u.join(__dirname,"/combined.log"))}),p=new d.Server(h),g=a.default(p),_=process.env.PORT||3333;p.listen(_,()=>{m.info(`server listening on ${_}`)});const v={};g.on("connection",e=>{m.info(`connected new client ${e.id}`),e.on("initSignIn",t=>r(this,void 0,void 0,function*(){try{const n=yield f.initSignIn(t);e.emit("signInSuccess",n),v[n.name]=e.id,e.broadcast.emit("user connected",n.name),m.info(`${n.name} is online`)}catch(t){"signInError"===t.message?e.emit("signInError"):(m.error(t),e.emit("serverError"))}})),e.on("initSignUp",t=>r(this,void 0,void 0,function*(){try{const n=yield f.initSignUp(t);e.emit("signUpSuccess",n),v[n.name]=e.id,e.broadcast.emit("user created",n.name),m.info(`new user ${n.name} joined`)}catch(t){"signUpError"===t.message?e.emit("signUpError"):(m.error(t),e.emit("serverError"))}})),e.on("initChat",()=>r(this,void 0,void 0,function*(){try{const t=yield f.initChat();e.emit("initChatResponse",t)}catch(t){m.error(t),e.emit("serverError")}})),e.on("messageFromClient",t=>r(this,void 0,void 0,function*(){try{const n=yield f.messageFromClient(t);g.emit("messageFromServer",n)}catch(t){m.error(t),e.emit("serverError")}})),e.on("user leave",e=>r(this,void 0,void 0,function*(){if("default"!==e.name)try{yield f.userLeave(e.id),m.info(`${e.name} is offline`),delete v[e.name],g.emit("user leave",e.name)}catch(e){m.error(e)}}))})},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("http")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(7)),s=n(9).Base64;t.default=class{get initSignIn(){return this._initSignIn}get initSignUp(){return this._initSignUp}get initChat(){return this._initChat}get messageFromClient(){return this._messageFromClient}get userLeave(){return this._userLeave}_initSignIn(e){return r(this,void 0,void 0,function*(){try{const t=yield o.default(`SELECT password FROM users WHERE name="${s.encode(e.name)}";`);if(void 0===t[0]||s.decode(t[0].password)!==e.password)throw new Error("signInError");{yield o.default(`UPDATE users SET status = 'online' WHERE name="${s.encode(e.name)}";`);const t=yield o.default(`SELECT id, name, status FROM users WHERE name="${s.encode(e.name)}"`);return t[0].name=s.decode(t[0].name),t[0]}}catch(e){throw e}})}_initSignUp(e){return r(this,void 0,void 0,function*(){try{if((yield o.default(`SELECT name FROM users WHERE name="${s.encode(e.name)}";`))[0])throw new Error("signUpError");{yield o.default(`INSERT INTO users (name, password, status) VALUES ('${s.encode(e.name)}', '${s.encode(e.password)}', 'online');`);const t=yield o.default(`SELECT id, name, status FROM users WHERE name="${s.encode(e.name)}"`);return t[0].name=s.decode(t[0].name),t[0]}}catch(e){throw e}})}_initChat(){return r(this,void 0,void 0,function*(){try{const e=yield o.default('SELECT *, NULL AS password FROM users, messages WHERE messages.author_id = users.id AND messages.room="public";');for(let t of e)t.name=s.decode(t.name),t.text=s.decode(t.text);return e.sort((e,t)=>e.date>t.date?1:e.date<t.date?-1:void 0),e}catch(e){throw e}})}_messageFromClient(e){return r(this,void 0,void 0,function*(){try{const t=Date.now();yield o.default(`INSERT INTO messages (date, text, author_id) VALUES (${t},'${s.encode(e.text)}', '${e.author_id}');`);const n=yield o.default(`SELECT *, NULL AS password FROM users, messages WHERE users.id = ${e.author_id} AND messages.room="public" AND messages.date=${t} AND messages.text="${s.encode(e.text)}";`);return n[0].name=s.decode(n[0].name),n[0].text=s.decode(n[0].text),n[0]}catch(e){throw e}})}_userLeave(e){return r(this,void 0,void 0,function*(){return o.default(`UPDATE users SET status = 'offline' WHERE id="${e}";`).catch(e=>{throw e})})}}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(8)),s={host:"128.199.39.117",user:"node",password:"edon",database:"pretty_chat",port:3306};t.default=(e=>r(this,void 0,void 0,function*(){try{const t=yield o.default.createConnection(s),n=yield t.query(e);return t.end(),n}catch(e){throw e}}))},function(e,t){e.exports=require("promise-mysql")},function(e,t){e.exports=require("js-base64")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(11);t.default=class{constructor(){this._logger=r.createLogger({format:r.format.combine(r.format.timestamp(),r.format.printf(e=>`\n    ${e.timestamp} [${e.level}]: ${e.message}`)),transports:[new r.transports.Console,new r.transports.File({filename:"combined.log"})]})}_info(e){this._logger.info(e)}get info(){return this._info}_error(e){let t="";for(let n in e)t+=`${n}: ${e[n]}; `;this._logger.error(t)}get error(){return this._error}}},function(e,t){e.exports=require("winston")}]);