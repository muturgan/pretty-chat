!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}d((r=r.apply(e,t||[])).next())})},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(1)),s=o(n(2)),a=n(3),d=n(4),u=o(n(5)),c=o(n(9)),l=i.default().use(i.default.static(a.join(__dirname,"../static"))).use(i.default.json()).use(i.default.urlencoded({extended:!0})).get("/",(e,t)=>{t.sendFile(a.join(__dirname,"/../static/index.html"))}).get("/sign-in",(e,t)=>{t.sendFile(a.join(__dirname,"/../static/index.html"))}).get("/sign-up",(e,t)=>{t.sendFile(a.join(__dirname,"/../static/index.html"))}).get("/chat",(e,t)=>{t.sendFile(a.join(__dirname,"/../static/index.html"))}).get("/getLogs",(e,t)=>{c.default.info(`logs were sent to ${e.url}`),t.sendFile(a.join(__dirname,"/../combined.log"))}),f=new d.Server(l),m=s.default(f),h=process.env.PORT||3333;f.listen(h,()=>{c.default.info(`server listening on ${h}`)});const p={};m.on("connection",e=>{c.default.info(`connected new client ${e.id}`),e.on("initSignIn",t=>r(this,void 0,void 0,function*(){try{const n=yield u.default.initSignIn(t);e.emit("signInSuccess",n),p[n.name]=e.id,e.broadcast.emit("user connected",n.name),c.default.info(`${n.name} is online`)}catch(t){"signInError"===t.message?e.emit("signInError"):(c.default.error(`errorno: ${t.errorno}; code: ${t.code}; syscall: ${t.syscall}; fatal: ${t.fatal}`),e.emit("serverError"))}})),e.on("initSignUp",t=>r(this,void 0,void 0,function*(){try{const n=yield u.default.initSignUp(t);e.emit("signUpSuccess",n),p[n.name]=e.id,e.broadcast.emit("user created",n.name),c.default.info(`new user ${n.name} joined`)}catch(t){"signUpError"===t.message?e.emit("signUpError"):(c.default.error(`errorno: ${t.errorno}; code: ${t.code}; syscall: ${t.syscall}; fatal: ${t.fatal}`),e.emit("serverError"))}})),e.on("initChat",()=>r(this,void 0,void 0,function*(){try{const t=yield u.default.initChat();e.emit("initChatResponse",t)}catch(t){c.default.error(`errorno: ${t.errorno}; code: ${t.code}; syscall: ${t.syscall}; fatal: ${t.fatal}`),e.emit("serverError")}})),e.on("messageFromClient",t=>r(this,void 0,void 0,function*(){try{const n=yield u.default.messageFromClient(t);m.emit("messageFromServer",n)}catch(t){c.default.error(`errorno: ${t.errorno}; code: ${t.code}; syscall: ${t.syscall}; fatal: ${t.fatal}`),e.emit("serverError")}})),e.on("user leave",e=>r(this,void 0,void 0,function*(){if("default"!==e.name)try{yield u.default.userLeave(e.id),c.default.info(`${e.name} is offline`),delete p[e.name],m.emit("user leave",e.name)}catch(e){c.default.error(`errorno: ${e.errorno}; code: ${e.code}; syscall: ${e.syscall}; fatal: ${e.fatal}`)}}))})},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("http")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}d((r=r.apply(e,t||[])).next())})},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(6)),s=n(8).Base64,a={initSignIn:e=>r(this,void 0,void 0,function*(){try{const t=yield i.default(`SELECT password FROM users WHERE name="${s.encode(e.name)}";`);if(void 0===t[0]||s.decode(t[0].password)!==e.password)throw new Error("signInError");{yield i.default(`UPDATE users SET status = 'online' WHERE name="${s.encode(e.name)}";`);const t=yield i.default(`SELECT id, name, status FROM users WHERE name="${s.encode(e.name)}"`);return t[0].name=s.decode(t[0].name),t[0]}}catch(e){throw e}}),initSignUp:e=>r(this,void 0,void 0,function*(){try{if((yield i.default(`SELECT name FROM users WHERE name="${s.encode(e.name)}";`))[0])throw new Error("signUpError");{yield i.default(`INSERT INTO users (name, password, status) VALUES ('${s.encode(e.name)}', '${s.encode(e.password)}', 'online');`);const t=yield i.default(`SELECT id, name, status FROM users WHERE name="${s.encode(e.name)}"`);return t[0].name=s.decode(t[0].name),t[0]}}catch(e){throw e}}),initChat:()=>r(this,void 0,void 0,function*(){try{const e=yield i.default('SELECT *, NULL AS password FROM users, messages WHERE messages.author_id = users.id AND messages.room="public";');for(let t of e)t.name=s.decode(t.name),t.text=s.decode(t.text);return e.sort((e,t)=>e.date>t.date?1:e.date<t.date?-1:void 0),e}catch(e){throw e}}),messageFromClient:e=>r(this,void 0,void 0,function*(){try{const t=Date.now();yield i.default(`INSERT INTO messages (date, text, author_id) VALUES (${t},'${s.encode(e.text)}', '${e.author_id}');`);const n=yield i.default(`SELECT *, NULL AS password FROM users, messages WHERE users.id = ${e.author_id} AND messages.room="public" AND messages.date=${t} AND messages.text="${s.encode(e.text)}";`);return n[0].name=s.decode(n[0].name),n[0].text=s.decode(n[0].text),n[0]}catch(e){throw e}}),userLeave:e=>r(this,void 0,void 0,function*(){return i.default(`UPDATE users SET status = 'offline' WHERE id="${e}";`).catch(e=>{throw e})})};t.default=a},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}d((r=r.apply(e,t||[])).next())})},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(7)),s={host:"128.199.39.117",user:"node",password:"edon",database:"pretty_chat",port:3306};t.default=(e=>r(this,void 0,void 0,function*(){try{const t=yield i.default.createConnection(s),n=yield t.query(e);return t.end(),n}catch(e){throw e}}))},function(e,t){e.exports=require("promise-mysql")},function(e,t){e.exports=require("js-base64")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(10)),i=o.default.createLogger({format:o.default.format.combine(o.default.format.timestamp(),o.default.format.printf(e=>`\n${e.timestamp} [${e.level}]: ${e.message}`)),transports:[new o.default.transports.Console,new o.default.transports.File({filename:"combined.log"})]});t.default=i},function(e,t){e.exports=require("winston")}]);